<style>
/* IMPORTANTE: Resetear el layout padre para el calendario */
body {
    overflow: hidden !important;
}

.container-fluid,
.container-fluid > .row,
.container-fluid > .row > .col {
    height: 100vh !important;
    padding: 0 !important;
    margin: 0 !important;
    max-height: 100vh !important;
    overflow: hidden !important;
}

/* Bot√≥n hamburguesa - posici√≥n absoluta */
.btn-menu-toggle {
    position: absolute !important;
    top: 1rem;
    left: 1rem;
    z-index: 100;
}

/* Calendario - Full Height */
.calendar-page-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    padding: 0.75rem;
    padding-top: 0.75rem;
    padding-left: 4rem; /* Espacio para hamburguesa */
    box-sizing: border-box;
    background: #f5f7f6;
}

.calendar-actions-card {
    flex-shrink: 0;
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
    padding: 0.5rem 1rem;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    flex-wrap: wrap;
    align-items: center;
}

.btn-calendar-primary {
    background: linear-gradient(135deg, var(--mint) 0%, var(--mint-dark) 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.4rem 0.875rem;
    font-weight: 600;
    font-size: 0.8rem;
    text-decoration: none;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
}

.btn-calendar-primary:hover {
    background: linear-gradient(135deg, var(--mint-hover) 0%, var(--mint) 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(126, 206, 197, 0.4);
    color: white;
}

.btn-calendar-outline {
    background: white;
    color: var(--mint-dark);
    border: 2px solid var(--mint);
    border-radius: 8px;
    padding: 0.4rem 0.875rem;
    font-weight: 500;
    font-size: 0.8rem;
    text-decoration: none;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
}

.btn-calendar-outline:hover {
    background: var(--mint);
    color: white;
}

.calendar-wrapper {
    flex: 1;
    min-height: 0;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    padding: 0.25rem;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.calendar-wrapper #calendar {
    flex: 1;
    min-height: 0;
    overflow: hidden;
}

/* FullCalendar height fix */
.calendar-wrapper .fc {
    height: 100% !important;
    display: flex;
    flex-direction: column;
}

.calendar-wrapper .fc .fc-view-harness {
    flex: 1;
    min-height: 0;
}

/* Modal Reserva - Tema Menta */
:root {
    --mint: #7ECEC5;
    --mint-light: #A8DDD7;
    --mint-dark: #5FBFB3;
    --mint-pale: #E8F6F4;
    --mint-hover: #6BC4BA;
}

.modal-reserva {
    border: none;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(126, 206, 197, 0.3);
}

.modal-header-mint {
    background: linear-gradient(135deg, var(--mint) 0%, var(--mint-dark) 100%);
    color: white;
    border: none;
    padding: 1.25rem 1.5rem;
}

.modal-header-mint .modal-title {
    font-weight: 600;
    font-size: 1.25rem;
}

.modal-header-mint .modal-title i {
    margin-right: 0.5rem;
}

.btn-close-mint {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-close-mint:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.05);
}

.modal-body-reserva {
    padding: 1.5rem;
    background: #fafcfb;
    max-height: 70vh;
    overflow-y: auto;
}

/* Progress Steps */
.reservation-steps {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    opacity: 0.5;
    transition: all 0.3s;
}

.step.active {
    opacity: 1;
}

.step.completed {
    opacity: 1;
}

.step.completed .step-number {
    background: var(--mint);
    color: white;
}

.step-number {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #e0e0e0;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.3s;
}

.step.active .step-number {
    background: var(--mint);
    color: white;
    box-shadow: 0 4px 12px rgba(126, 206, 197, 0.4);
}

.step span {
    font-size: 0.75rem;
    color: #666;
    font-weight: 500;
}

.step.active span {
    color: var(--mint-dark);
}

.step-line {
    width: 40px;
    height: 2px;
    background: #e0e0e0;
    margin: 0 0.5rem;
    margin-bottom: 1rem;
}

/* Sections */
.reservation-section {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    border: 1px solid #f0f0f0;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--mint-pale);
}

.section-header i {
    color: var(--mint);
    font-size: 1.1rem;
}

.section-header h6 {
    margin: 0;
    font-weight: 600;
    color: #333;
}

/* Form Elements */
.form-label-mint {
    font-size: 0.85rem;
    font-weight: 500;
    color: #555;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.form-label-mint i {
    color: var(--mint);
    font-size: 0.8rem;
}

.form-control-mint,
.form-select-mint {
    border: 2px solid #e8e8e8;
    border-radius: 10px;
    padding: 0.625rem 0.875rem;
    font-size: 0.9rem;
    transition: all 0.2s;
    background: white;
}

.form-control-mint:focus,
.form-select-mint:focus {
    border-color: var(--mint);
    box-shadow: 0 0 0 3px rgba(126, 206, 197, 0.15);
    outline: none;
}

.form-control-mint:read-only {
    background: var(--mint-pale);
    color: #555;
}

.input-group-mint {
    border-radius: 10px;
    overflow: hidden;
}

.input-group-mint .input-group-text {
    background: var(--mint-pale);
    border: 2px solid #e8e8e8;
    border-right: none;
    color: var(--mint-dark);
    font-weight: 500;
}

.input-group-mint .form-control-mint {
    border-left: none;
}

/* Buttons */
.btn-mint-primary {
    background: linear-gradient(135deg, var(--mint) 0%, var(--mint-dark) 100%);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 0.75rem 2rem;
    font-weight: 600;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(126, 206, 197, 0.3);
}

.btn-mint-primary:hover {
    background: linear-gradient(135deg, var(--mint-hover) 0%, var(--mint) 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(126, 206, 197, 0.4);
    color: white;
}

.btn-mint-primary:active {
    transform: translateY(0);
}

.btn-mint-primary i {
    margin-right: 0.5rem;
}

.btn-mint-outline {
    background: white;
    color: var(--mint-dark);
    border: 2px solid var(--mint);
    border-radius: 10px;
    padding: 0.5rem 1rem;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-mint-outline:hover {
    background: var(--mint);
    color: white;
}

.btn-mint-outline i {
    margin-right: 0.375rem;
}

/* Total Card */
.total-card {
    background: linear-gradient(135deg, var(--mint-pale) 0%, #fff 100%);
    border-radius: 10px;
    padding: 1rem 1.25rem;
    border: 2px solid var(--mint-light);
}

.total-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.total-row > span {
    font-weight: 600;
    color: #333;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.total-row > span i {
    color: var(--mint);
}

.total-row .form-control-mint {
    font-size: 1.1rem;
}

/* Loading Indicators */
.loading-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--mint-dark);
    font-size: 0.9rem;
    padding: 0.5rem 0;
}

.loading-indicator i {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    100% { transform: rotate(360deg); }
}

/* Disponibilidad Badge */
.disponibilidad-badge {
    padding: 0.625rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.disponibilidad-badge.disponible {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.disponibilidad-badge.no-disponible {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* Select Options (Dropdown personalizado) */
.select-container {
    position: relative;
}

.select-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid var(--mint-light);
    border-radius: 10px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.select-option {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.15s;
    border-bottom: 1px solid #f0f0f0;
}

.select-option:last-child {
    border-bottom: none;
}

.select-option:hover {
    background: var(--mint-pale);
}

.select-option.selected {
    background: var(--mint-light);
}

.select-option i {
    color: var(--mint);
    margin-right: 0.5rem;
}

.select-option small {
    color: #888;
}

/* Modal Footer */
.modal-footer-mint {
    background: white;
    border-top: 1px solid #f0f0f0;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: flex-end;
}

/* Error Message */
.error-message {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

/* Option Styles for Availability */
#tipologia_habitacion option[data-available="true"] {
    background-color: #d4edda;
}

#tipologia_habitacion option[data-available="false"] {
    background-color: #f8d7da;
    color: #999;
}

/* Responsive */
@media (max-width: 768px) {
    .reservation-steps {
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .step-line {
        display: none;
    }
    
    .step {
        flex: 0 0 auto;
    }
    
    .modal-body-reserva {
        padding: 1rem;
    }
}

/* Scrollbar personalizado */
.modal-body-reserva::-webkit-scrollbar {
    width: 6px;
}

.modal-body-reserva::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 3px;
}

.modal-body-reserva::-webkit-scrollbar-thumb {
    background: var(--mint-light);
    border-radius: 3px;
}

.modal-body-reserva::-webkit-scrollbar-thumb:hover {
    background: var(--mint);
}
</style>

<div class="loader loader--hidden"></div>
<div class="pre-loader"></div>

<div class="calendar-page-container">
    <!-- Tarjeta de acciones -->
    <div class="calendar-actions-card">
        <a id="crear-reserva-btn" class="btn btn-calendar-primary" href="#" role="button"
            data-bs-toggle="modal" data-bs-target="#event_entry_modal">
            <i class="fa fa-plus-circle"></i> Crear reserva
        </a>
        <a id="bloquear-fechas-btn" class="btn btn-calendar-primary" href="#" role="button"
            data-bs-toggle="modal" data-bs-target="#bloqueo_modal">
            <i class="fa fa-plus-circle"></i> Bloquear fechas
        </a>
        <a class="btn btn-calendar-outline" href="/api/cabanas/calendar" role="button">
            <i class="fa fa-building"></i> Ir a calendario de habitaciones
        </a>
    </div>

    <!-- Contenedor del calendario -->
    <div class="calendar-wrapper">
        <div id="calendar"></div>
    </div>
</div>

<div id="context-menu">
    <ul>
        <li id="edit"><i class="fa fa-share-square" aria-hidden="true"></i>&nbsp Ver Reserva</li>
        <li id="delete"><i class="fa fa-trash" aria-hidden="true"></i>&nbsp Cancelar Reserva</li>
        <li id="move-to-playground"><i class="fa fa-gamepad" aria-hidden="true"></i>&nbsp Mover al Playground</li>
        <li id="move-to-active"><i class="fa fa-check-circle" aria-hidden="true"></i> &nbsp Cambiar a Activa</li>
        <li id="move-to-noshow"><i class="fa fa-eye-slash" aria-hidden="true"></i> &nbsp Cambiar a No Show</li>
    </ul>
</div>




<!-- Modals -->
<div class="modal fade" id="event_entry_modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content modal-reserva">
            <div class="modal-header modal-header-mint">
                <h5 class="modal-title" id="modalLabel">
                    <i class="fa fa-calendar-plus"></i> Nueva Reserva
                </h5>
                <button type="button" class="btn-close-mint" onclick="$('#event_entry_modal').modal('hide');" aria-label="Close">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="modal-body modal-body-reserva">
                <!-- Progress Steps -->
                <div class="reservation-steps">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <span>Cliente</span>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <span>Fechas</span>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <span>Habitaci√≥n</span>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" data-step="4">
                        <div class="step-number">4</div>
                        <span>Confirmar</span>
                    </div>
                </div>

                <!-- Step 1: Cliente -->
                <div class="reservation-section" id="section-cliente">
                    <div class="section-header">
                        <i class="fa fa-user"></i>
                        <h6>Informaci√≥n del cliente</h6>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label-mint">
                                <i class="fa fa-tag"></i> Tipo de reserva
                            </label>
                            <select id="tipo-reserva-select" class="form-select form-select-mint" required>
                                <option value="por-depo" selected>Tentativa (por dep√≥sito)</option>
                                <option value="reserva">Reserva confirmada</option>
                            </select>
                        </div>
                    </div>

                    <!-- Cliente existente -->
                    <div class="container-alta-cliente d-none">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-9">
                                <label class="form-label-mint">
                                    <i class="fa fa-search"></i> Buscar cliente
                                </label>
                                <div class="select-container">
                                    <input type="text" class="form-control form-control-mint form-select-search" 
                                            id="lblClient" 
                                            autocomplete="off"
                                            placeholder="Escribe para buscar...">
                                    <div class="select-options">
                                        {{#if clientes}}
                                            {{#each clientes}}
                                            <div class="select-option" data-value="{{this.email}}" data-label="{{this.firstName}} {{this.lastName}} ({{this.email}})">
                                                <i class="fa fa-user-circle"></i> {{this.firstName}} {{this.lastName}} <small>({{this.email}})</small>
                                            </div>
                                            {{/each}}
                                        {{else}}
                                            <div class="select-option" data-value="0">No hay clientes registrados</div>
                                        {{/if}}
                                    </div>
                                    <input type="hidden" id="lblClientValue">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-mint-outline w-100" data-bs-toggle="modal" data-bs-target="#clientEntryModal">
                                    <i class="fa fa-user-plus"></i> Nuevo
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Cliente provisional (tentativa) -->
                    <div id="container-alta-cliente-provisional">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label-mint">
                                    <i class="fa fa-user"></i> Nombre
                                </label>
                                <input type="text" id="nombre-cliente-provisional" class="form-control form-control-mint"
                                    placeholder="Nombre del cliente">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-mint">
                                    <i class="fa fa-user"></i> Apellido
                                </label>
                                <input type="text" id="apellido-cliente-provisional" class="form-control form-control-mint"
                                    placeholder="Apellido del cliente">
                            </div>
                            <div class="col-md-12">
                                <label class="form-label-mint">
                                    <i class="fa fa-phone"></i> Tel√©fono <small class="text-muted">(opcional)</small>
                                </label>
                                <div class="input-group input-group-mint">
                                    <select class="form-select" id="codigo-pais-select" style="max-width: 110px;">
                                        <option value="1">üá∫üá∏ +1</option>
                                        <option value="52" selected>üá≤üáΩ +52</option>
                                    </select>
                                    <input type="tel" id="telefono-cliente-provisional" class="form-control form-control-mint"
                                        placeholder="10 d√≠gitos" maxlength="10">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Fechas y Filtro -->
                <div class="reservation-section" id="section-fechas">
                    <div class="section-header">
                        <i class="fa fa-calendar-alt"></i>
                        <h6>Selecciona las fechas</h6>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label-mint">
                                <i class="fa fa-calendar-week"></i> Rango de fechas
                            </label>
                            <input type="text" id="date_range" class="form-control form-control-mint"
                                placeholder="Selecciona check-in y check-out">
                            <input type="hidden" id="event_start_date">
                            <input type="hidden" id="event_end_date">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label-mint">
                                <i class="fa fa-moon"></i> Noches
                            </label>
                            <input type="number" id="event_nights" class="form-control form-control-mint" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label-mint">
                                <i class="fa fa-filter"></i> Tipolog√≠a
                            </label>
                            <select class="form-select form-select-mint" id="tipologia_select">
                                <option value="" selected>Todas</option>
                                {{#if tipologias}}
                                {{#each tipologias}}
                                <option value="{{this.tipologia}}">{{this.tipologia}}</option>
                                {{/each}}
                                {{/if}}
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mt-2">
                        <div class="col-12">
                            <button type="button" class="btn btn-mint-outline w-100" id="btn-validar-disponibilidad">
                                <i class="fa fa-search"></i> Buscar habitaciones disponibles
                            </button>
                        </div>
                    </div>

                    <!-- Indicador de disponibilidad -->
                    <div id="verificar-disponibilidad" class="loading-indicator" style="display: none;">
                        <i class="fa fa-spinner fa-spin"></i> Verificando disponibilidad...
                    </div>
                    <div id="disponibilidad-status" class="disponibilidad-badge mt-3" style="display: none;">
                        <span id="disponibilidad-text"></span>
                    </div>
                </div>

                <!-- Step 3: Selecci√≥n de Habitaci√≥n (solo visible despu√©s de validar) -->
                <div class="reservation-section" id="section-habitacion" style="display: none;">
                    <div class="section-header">
                        <i class="fa fa-bed"></i>
                        <h6>Habitaciones disponibles</h6>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label-mint">
                                <i class="fa fa-home"></i> Selecciona una habitaci√≥n
                            </label>
                            <select name="tipologia_habitacion" id="tipologia_habitacion"
                                class="form-select form-select-mint" required>
                                <option value="" selected disabled>Primero busca disponibilidad</option>
                                {{#if chalets}}
                                {{#each chalets}}
                                <option value="{{this.name}}" data-bs-pax="{{this.pax}}" data-bs-id="{{this.id}}"
                                    data-bs-tipologia="{{this.tipologia}}" data-bs-isgroup="{{this.isGroup}}"
                                    style="display: none;">
                                    {{#if this.isGroup}}{{this.name}} (Grupo - {{this.totalRooms}} hab.){{else}}{{this.name}}{{/if}}</option>
                                {{/each}}
                                {{/if}}
                            </select>
                            <input type="hidden" id="id_cabana">
                        </div>
                    </div>

                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label class="form-label-mint">
                                <i class="fa fa-users"></i> Ocupaci√≥n m√°x.
                            </label>
                            <input type="number" id="ocupacion_habitacion" class="form-control form-control-mint" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-mint">
                                <i class="fa fa-user-friends"></i> Hu√©spedes
                            </label>
                            <select id="numero-personas" class="form-select form-select-mint" required>
                                <option value="" selected disabled>Personas</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Resumen y Total -->
                <div class="reservation-section" id="section-total">
                    <div class="section-header">
                        <i class="fa fa-receipt"></i>
                        <h6>Resumen de la reserva</h6>
                    </div>

                    <div id="calculando-precios" class="loading-indicator" style="display: none;">
                        <i class="fa fa-calculator fa-spin"></i> Calculando precio...
                    </div>

                    <div class="total-card">
                        <div class="total-row">
                            <span><i class="fa fa-money-bill-wave"></i> Total a cobrar</span>
                            <div class="input-group input-group-mint" style="max-width: 200px;">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control form-control-mint text-end fw-bold"
                                    id="habitacion_total" min="0" placeholder="0.00">
                                <span class="input-group-text">MXN</span>
                            </div>
                        </div>
                        <input type="hidden" id="total-sin-comisiones">
                        <input type="hidden" id="total-costo-base">
                    </div>
                </div>

                <div class="form-item">
                    <p id="txtReservationError" name="errMsg" class="error-message"></p>
                </div>
            </div>
            <div class="modal-footer modal-footer-mint">
                <button type="button" class="btn btn-mint-primary btn-lg" id="save-event-btn">
                    <i class="fa fa-check-circle"></i> Crear Reserva
                </button>
            </div>
        </div>
    </div>
</div>
<!-- End popup dialog box -->

<!-- Modal alta cliente -->
<div class="modal fade" id="clientEntryModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel"
    aria-hidden="true">
    <form id="frmCreateClient" action="/api/clientes/crear-cliente" method="post" class="modal-dialog modal-md"
        role="document">
        <div class="modal-content modal-reserva">
            <div class="modal-header modal-header-mint">
                <h5 class="modal-title">
                    <i class="fa fa-user-plus"></i> Nuevo Cliente
                </h5>
                <button type="button" class="btn-close-mint" onclick="$('#clientEntryModal').modal('hide');" 
                    data-bs-target="#event_entry_modal" data-bs-toggle="modal" aria-label="Close">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="modal-body modal-body-reserva">
                <div class="reservation-section">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label-mint">
                                <i class="fa fa-user"></i> Nombre
                            </label>
                            <input type="text" name="txtClientName" id="txtClientName"
                                class="form-control form-control-mint" placeholder="Nombre">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-mint">
                                <i class="fa fa-user"></i> Apellido
                            </label>
                            <input type="text" name="txtClientLastname" id="txtClientLastname" 
                                class="form-control form-control-mint" placeholder="Apellido">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-mint">
                                <i class="fa fa-phone"></i> Tel√©fono
                            </label>
                            <input type="tel" name="txtClientPhone" id="txtClientPhone" 
                                class="form-control form-control-mint" placeholder="Tel√©fono">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-mint">
                                <i class="fa fa-envelope"></i> Email
                            </label>
                            <input type="email" name="txtClientEmail" id="txtClientEmail" 
                                class="form-control form-control-mint" placeholder="correo@ejemplo.com">
                        </div>
                        <div class="col-12">
                            <label class="form-label-mint">
                                <i class="fa fa-map-marker-alt"></i> Direcci√≥n
                            </label>
                            <input type="text" name="txtClientAddress" id="txtClientAddress" 
                                class="form-control form-control-mint" placeholder="Direcci√≥n completa">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-mint">
                                <i class="fa fa-id-card"></i> Tipo de ID
                            </label>
                            <select name="slctClientIdType" id="slctClientIdType"
                                class="form-select form-select-mint" required>
                                <option value="" selected disabled>Selecciona...</option>
                                <option value="INE">INE</option>
                                <option value="Pasaporte">Pasaporte</option>
                                <option value="Licencia de conducir">Licencia de conducir</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-mint">
                                <i class="fa fa-hashtag"></i> N√∫mero de ID
                            </label>
                            <input type="text" name="txtClientIdNumber" id="txtClientIdNumber" 
                                class="form-control form-control-mint" placeholder="N√∫mero de identificaci√≥n">
                        </div>
                    </div>
                </div>
                <p id="txtInsertClientError" name="errMsg" class="error-message"></p>
            </div>
            <div class="modal-footer modal-footer-mint" style="justify-content: space-between;">
                <button type="button" class="btn btn-mint-outline" data-bs-target="#event_entry_modal" data-bs-toggle="modal"
                    data-bs-dismiss="modal">
                    <i class="fa fa-arrow-left"></i> Regresar
                </button>
                <button type="button" class="btn btn-mint-primary" id="btnSaveClient">
                    <i class="fa fa-save"></i> Guardar Cliente
                </button>
            </div>
        </div>
    </form>
</div>
<!-- End Modal Alta cliente -->

<!-- Modal Bloqueo de Fechas -->
<div class="modal fade" id="bloqueo_modal" tabindex="-1" role="dialog" aria-labelledby="bloqueoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content modal-reserva">
            <div class="modal-header modal-header-mint">
                <h5 class="modal-title" id="bloqueoModalLabel">
                    <i class="fa fa-ban"></i> Bloquear fechas
                </h5>
                <button type="button" class="btn-close-mint" onclick="$('#bloqueo_modal').modal('hide');" aria-label="Close">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="modal-body modal-body-reserva">
                <!-- Secci√≥n de habitaciones -->
                <div class="reservation-section">
                    <div class="section-header">
                        <i class="fa fa-bed"></i>
                        <h6>Selecciona las habitaciones</h6>
                    </div>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label-mint">
                                <i class="fa fa-search"></i> Buscar habitaciones
                            </label>
                            <input type="text" id="search-habitaciones" class="form-control form-control-mint"
                                placeholder="Escribe para buscar...">
                        </div>
                        <div class="col-12">
                            <div id="habitaciones-list" class="habitaciones-checkbox-list" style="max-height: 200px; overflow-y: auto; border: 2px solid #e8e8e8; border-radius: 10px; padding: 0.75rem;">
                                {{#if habitacionesIndividuales}}
                                {{#each habitacionesIndividuales}}
                                <div class="form-check habitacion-item" data-name="{{this.name}}">
                                    <input class="form-check-input" type="checkbox" value="{{this.id}}" id="hab_{{this.id}}">
                                    <label class="form-check-label" for="hab_{{this.id}}">
                                        {{this.name}}{{#if this.tipologia}} ({{this.tipologia}}){{/if}}
                                    </label>
                                </div>
                                {{/each}}
                                {{else}}
                                <p class="text-muted">No hay habitaciones disponibles</p>
                                {{/if}}
                            </div>
                        </div>
                        <div class="col-12">
                            <small class="text-muted" id="habitaciones-selected-count">0 habitaciones seleccionadas</small>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n de rangos de fechas -->
                <div class="reservation-section">
                    <div class="section-header">
                        <i class="fa fa-calendar-alt"></i>
                        <h6>Rangos de fechas a bloquear</h6>
                    </div>
                    <div id="rangos-container">
                        <!-- Los rangos se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                    <button type="button" class="btn btn-mint-outline w-100" id="btn-agregar-rango">
                        <i class="fa fa-plus-circle"></i> Agregar rango de fechas
                    </button>
                </div>

                <!-- Secci√≥n de motivo -->
                <div class="reservation-section">
                    <div class="section-header">
                        <i class="fa fa-comment"></i>
                        <h6>Motivo del bloqueo</h6>
                    </div>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label-mint">
                                <i class="fa fa-pencil-alt"></i> Descripci√≥n <small class="text-muted">(opcional)</small>
                            </label>
                            <textarea id="motivo-bloqueo" class="form-control form-control-mint" rows="3"
                                placeholder="Ej: Mantenimiento programado, Reparaciones, etc."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-item">
                    <p id="txtBloqueoError" name="errMsg" class="error-message"></p>
                </div>
            </div>
            <div class="modal-footer modal-footer-mint">
                <button type="button" class="btn btn-mint-primary btn-lg" id="save-bloqueo-btn">
                    <i class="fa fa-check-circle"></i> Crear Bloqueos
                </button>
            </div>
        </div>
    </div>
</div>
<!-- End Modal Bloqueo de Fechas -->



<!-- Bootstrap JavaScript Libraries -->
<script src="/scripts/calendar.js"></script>
<script src="/scripts/functions.js"></script>
<script>
    // Fix para m√∫ltiples modales
    $(document).on('hidden.bs.modal', function (event) {
        if ($('.modal:visible').length) {
            $('body').addClass('modal-open');
        }
    });

    // Preloader
    window.addEventListener("load", () => {
        const preloader = document.querySelector(".pre-loader");
        preloader.classList.add("loader--hidden");
        preloader.addEventListener("transitionend", () => {
            if (preloader) {
                preloader.style.display = "none";
            }
        });
    });

    // ===== MODAL BLOQUEO DE FECHAS =====
    let rangoCounter = 0;
    let flatpickrInstances = {};

    // Agregar rango de fechas
    document.getElementById('btn-agregar-rango').addEventListener('click', function() {
        rangoCounter++;
        const rangoId = `rango_${rangoCounter}`;
        
        const rangoHtml = `
            <div class="rango-item mb-3" id="${rangoId}" style="border: 2px solid var(--mint-pale); border-radius: 10px; padding: 1rem; position: relative;">
                <button type="button" class="btn btn-sm" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #f8d7da; color: #721c24; border: none; border-radius: 50%; width: 30px; height: 30px; padding: 0;" onclick="eliminarRango('${rangoId}')">
                    <i class="fa fa-times"></i>
                </button>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label-mint">
                            <i class="fa fa-calendar-week"></i> Rango ${rangoCounter}
                        </label>
                        <input type="text" class="form-control form-control-mint rango-fechas" id="fechas_${rangoId}" placeholder="Selecciona las fechas">
                        <input type="hidden" class="fecha-inicio" id="inicio_${rangoId}">
                        <input type="hidden" class="fecha-fin" id="fin_${rangoId}">
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('rangos-container').insertAdjacentHTML('beforeend', rangoHtml);
        
        // Inicializar flatpickr para este rango
        flatpickrInstances[rangoId] = flatpickr(`#fechas_${rangoId}`, {
            mode: "range",
            dateFormat: "d-m-Y",
            locale: {
                rangeSeparator: " ‚Üí "
            },
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length === 1) {
                    // Si solo hay una fecha, usarla para inicio y fin (mismo d√≠a)
                    document.getElementById(`inicio_${rangoId}`).value = selectedDates[0].toISOString().split('T')[0];
                    document.getElementById(`fin_${rangoId}`).value = selectedDates[0].toISOString().split('T')[0];
                } else if (selectedDates.length === 2) {
                    document.getElementById(`inicio_${rangoId}`).value = selectedDates[0].toISOString().split('T')[0];
                    document.getElementById(`fin_${rangoId}`).value = selectedDates[1].toISOString().split('T')[0];
                }
            },
            onClose: function(selectedDates, dateStr, instance) {
                // Permitir bloqueo de un solo d√≠a
                if (selectedDates.length === 1) {
                    document.getElementById(`inicio_${rangoId}`).value = selectedDates[0].toISOString().split('T')[0];
                    document.getElementById(`fin_${rangoId}`).value = selectedDates[0].toISOString().split('T')[0];
                }
            }
        });
    });

    // Funci√≥n global para eliminar rango
    window.eliminarRango = function(rangoId) {
        const rangoElement = document.getElementById(rangoId);
        if (rangoElement) {
            // Destruir instancia de flatpickr
            if (flatpickrInstances[rangoId]) {
                flatpickrInstances[rangoId].destroy();
                delete flatpickrInstances[rangoId];
            }
            rangoElement.remove();
        }
    };

    // B√∫squeda de habitaciones
    document.getElementById('search-habitaciones').addEventListener('input', function(e) {
        const searchText = e.target.value.toLowerCase();
        const habitacionItems = document.querySelectorAll('.habitacion-item');
        
        habitacionItems.forEach(item => {
            const nombre = item.dataset.name.toLowerCase();
            if (nombre.includes(searchText)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });

    // Contador de habitaciones seleccionadas
    document.getElementById('habitaciones-list').addEventListener('change', function() {
        const checkedBoxes = document.querySelectorAll('#habitaciones-list input[type="checkbox"]:checked');
        document.getElementById('habitaciones-selected-count').textContent = `${checkedBoxes.length} habitaciones seleccionadas`;
    });

    // Guardar bloqueos
    document.getElementById('save-bloqueo-btn').addEventListener('click', async function() {
        const spinner = document.querySelector('.loader');
        const errorElement = document.getElementById('txtBloqueoError');
        errorElement.textContent = '';

        try {
            spinner.classList.remove('loader--hidden');

            // Obtener habitaciones seleccionadas
            const habitacionesChecked = document.querySelectorAll('#habitaciones-list input[type="checkbox"]:checked');
            
            console.log('üîç Debug - Checkboxes marcados:', habitacionesChecked.length);
            habitacionesChecked.forEach((cb, index) => {
                console.log(`  ${index + 1}. ID del checkbox: "${cb.id}", Value: "${cb.value}", Checked: ${cb.checked}`);
            });
            
            const habitacionIds = Array.from(habitacionesChecked)
                .map(cb => cb.value)
                .filter(id => id && id.trim() !== ''); // Filtrar valores vac√≠os
            
            console.log('üìã IDs finales a enviar:', habitacionIds);

            if (habitacionIds.length === 0) {
                throw new Error('Debes seleccionar al menos una habitaci√≥n');
            }

            // Obtener rangos de fechas
            const rangoItems = document.querySelectorAll('.rango-item');
            const dates = [];
            
            rangoItems.forEach(item => {
                const rangoId = item.id;
                const fechaInicio = document.getElementById(`inicio_${rangoId}`).value;
                const fechaFin = document.getElementById(`fin_${rangoId}`).value;
                
                if (fechaInicio && fechaFin) {
                    dates.push({
                        fechaInicio,
                        fechaFin
                    });
                }
            });

            if (dates.length === 0) {
                throw new Error('Debes agregar al menos un rango de fechas');
            }

            // Validar que no se solapen los rangos
            for (let i = 0; i < dates.length; i++) {
                const inicio1 = new Date(dates[i].fechaInicio);
                const fin1 = new Date(dates[i].fechaFin);
                
                // Validar que fecha fin >= fecha inicio
                if (fin1 < inicio1) {
                    throw new Error(`El rango ${i + 1} tiene fecha fin anterior a fecha inicio`);
                }
                
                // Validar solapamiento con otros rangos
                for (let j = i + 1; j < dates.length; j++) {
                    const inicio2 = new Date(dates[j].fechaInicio);
                    const fin2 = new Date(dates[j].fechaFin);
                    
                    // Verificar si se solapan
                    if ((inicio1 <= fin2 && fin1 >= inicio2)) {
                        throw new Error(`Los rangos ${i + 1} y ${j + 1} se solapan. Por favor ajusta las fechas.`);
                    }
                }
            }

            // Obtener motivo
            const motivo = document.getElementById('motivo-bloqueo').value.trim();

            // Preparar body
            const bodyData = {
                dates,
                habitacionIds,
                motivo
            };

            console.log('Enviando:', bodyData);

            // Enviar a la API
            const response = await fetch('/api/calendario-bloqueorango', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bodyData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Error al crear los bloqueos');
            }

            const data = await response.json();
            console.log('Respuesta:', data);

            Swal.fire({
                icon: 'success',
                title: 'Bloqueos creados',
                html: `
                    <p>${data.message}</p>
                    <p><strong>Habitaciones:</strong> ${data.totalHabitaciones}</p>
                    <p><strong>Fechas por habitaci√≥n:</strong> ${data.totalFechas}</p>
                    <p><strong>Nuevos bloqueos:</strong> ${data.totalCreadas}</p>
                    <p><strong>Actualizados:</strong> ${data.totalActualizadas}</p>
                `,
                confirmButtonText: 'Aceptar'
            }).then(() => {
                $('#bloqueo_modal').modal('hide');
                location.reload();
            });

        } catch (error) {
            console.error('Error:', error);
            errorElement.textContent = error.message;
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message,
                confirmButtonText: 'Aceptar'
            });
        } finally {
            spinner.classList.add('loader--hidden');
        }
    });

    // Limpiar modal al cerrar
    $('#bloqueo_modal').on('hidden.bs.modal', function() {
        // Limpiar rangos
        document.getElementById('rangos-container').innerHTML = '';
        Object.values(flatpickrInstances).forEach(fp => fp.destroy());
        flatpickrInstances = {};
        rangoCounter = 0;
        
        // Limpiar habitaciones
        document.querySelectorAll('#habitaciones-list input[type="checkbox"]').forEach(cb => cb.checked = false);
        document.getElementById('habitaciones-selected-count').textContent = '0 habitaciones seleccionadas';
        document.getElementById('search-habitaciones').value = '';
        document.querySelectorAll('.habitacion-item').forEach(item => item.style.display = 'block');
        
        // Limpiar motivo
        document.getElementById('motivo-bloqueo').value = '';
        
        // Limpiar error
        document.getElementById('txtBloqueoError').textContent = '';
    });

    // Agregar primer rango al abrir el modal
    $('#bloqueo_modal').on('shown.bs.modal', function() {
        if (rangoCounter === 0) {
            document.getElementById('btn-agregar-rango').click();
        }
    
    });
</script>