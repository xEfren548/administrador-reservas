<h2>Mis propiedades locales</h2>
<table class="table">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>En Channex</th>
            <th>Listing Airbnb mapeado</th>
            <th>Acción</th>
            <th>Tarifas</th>
        </tr>
    </thead>
    <tbody>
        {{#each propiedades}}
        <tr>
            <td>{{propertyDetails.name}}</td>
            <td>
                {{#if channexPropertyId}}
                {{#if existeEnChannex}}
                <span class="badge bg-success">Sí</span><br><small>ID: {{channexPropertyId}}</small>
                {{else}}
                <span class="badge bg-danger">No existe en Channex</span><br><small>ID local:
                    {{channexPropertyId}}</small>
                {{/if}}
                {{else}}
                <span class="badge bg-secondary">No</span>
                {{/if}}
            </td>
            <td>
                {{#if nombreListingAirbnb}}
                <span class="text-success fw-bold">{{nombreListingAirbnb}}</span>
                {{else}}
                <span class="text-muted">Sin mapping</span>
                {{/if}}
            </td>
            <td>
                {{#if channexPropertyId}}
                {{#if existeEnChannex}}
                <span class="text-success">Dada de alta</span>
                {{else}}
                <button type="button" class="btn btn-sm btn-warning alta-btn" data-id="{{_id}}">Dar de alta de
                    nuevo</button>
                {{/if}}
                {{else}}
                <button type="button" class="btn btn-sm btn-primary alta-btn" data-id="{{_id}}">Dar de alta</button>
                {{/if}}
            </td>
            <td>
                {{#if channexPropertyId}}
                <button type="button" class="btn btn-sm btn-info crear-tarifa-btn"
                    data-propertyid="{{channexPropertyId}}" data-propertyname="{{propertyDetails.name}}">
                    Crear tarifa
                </button>
                {{else}}
                <button type="button" class="btn btn-sm btn-secondary" disabled>Debe estar en Channex</button>
                {{/if}}
            </td>

        </tr>
        {{/each}}
    </tbody>
</table>

<h4 class="mt-4">Listings de Airbnb en Channex</h4>
<ul class="list-group">
    {{#each chProps}}
    <li class="list-group-item">
        <span class="fw-bold">{{this.title}}</span>
        <small>(ID: {{this.id}})</small>
    </li>
    {{/each}}
</ul>

{{!-- Modal tarifas --}}
<div class="modal fade" id="tarifaModal" tabindex="-1" aria-labelledby="tarifaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="tarifaForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tarifaModalLabel">Crear tarifa para <span id="propName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="inputPropertyId" name="property_id">
                    <div class="mb-3">
                        <label for="roomTitle" class="form-label">Nombre del Room</label>
                        <input type="text" class="form-control" id="roomTitle" name="room_title" required>
                    </div>
                    <div class="mb-3">
                        <label for="rateTitle" class="form-label">Nombre de la Tarifa</label>
                        <input type="text" class="form-control" id="rateTitle" name="rate_title" required>
                    </div>
                    <!-- Puedes agregar más campos si lo necesitas -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Room y Tarifa</button>
                </div>
            </div>
        </form>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const altaButtons = document.querySelectorAll('.alta-btn');
        altaButtons.forEach(button => {
            button.addEventListener('click', async function (event) {
                event.preventDefault();
                const propertyId = this.getAttribute('data-id');
                try {
                    const response = await fetch(`/api/channex/properties/${propertyId}/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Propiedad dada de alta',
                            text: 'La propiedad fue creada en Channex.',
                            confirmButtonText: 'Aceptar'
                        }).then(() => window.location.reload());
                    } else {
                        throw new Error(data.error || 'Error al dar de alta');
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message,
                        confirmButtonText: 'Aceptar'
                    });
                }
            });
        });
        document.querySelectorAll('.crear-tarifa-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.getElementById('inputPropertyId').value = btn.dataset.propertyid;
                document.getElementById('roomTitle').value = "ROOM " + btn.dataset.propertyname.toUpperCase();
                document.getElementById('rateTitle').value = "RATE " + btn.dataset.propertyname.toUpperCase();
                document.getElementById('propName').textContent = btn.dataset.propertyname;
                new bootstrap.Modal(document.getElementById('tarifaModal')).show();
            });
        });

        // Maneja el submit del formulario
        document.getElementById('tarifaForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const property_id = document.getElementById('inputPropertyId').value;
            const room_title = document.getElementById('roomTitle').value;
            const rate_title = document.getElementById('rateTitle').value;

            try {
                // 1. Crea Room
                const roomRes = await fetch('/api/channex/rooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_type: {
                            property_id: property_id,
                            title: room_title,
                            count_of_rooms: 1,
                            occ_adults: 2,
                            default_occupancy: 2,
                            occ_children: 0,
                            occ_infants: 0
                        }
                    })
                });
                const roomData = await roomRes.json();
                if (!roomRes.ok) throw new Error(roomData.error || 'Error creando room');

                const room_type_id = roomData.data.id;

                // 2. Crea Rate
                const rateRes = await fetch('/api/channex/rates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rate_plan: {
                            title: rate_title,
                            property_id: property_id,
                            room_type_id: room_type_id,
                            parent_rate_plan_id: null,
                            options: [{ occupancy: 2, is_primary: true }],
                            children_fee: "0.00",
                            infant_fee: "0.00",
                            currency: "MXN", // Puedes ajustar la moneda
                            sell_mode: "per_room",
                            rate_mode: "manual"
                        }
                    })
                });
                const rateData = await rateRes.json();
                if (!rateRes.ok) throw new Error(rateData.error || 'Error creando rate');

                Swal.fire({
                    icon: 'success',
                    title: 'Room y tarifa creados correctamente',
                    confirmButtonText: 'Aceptar'
                }).then(() => window.location.reload());

            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message,
                    confirmButtonText: 'Aceptar'
                });
            }
        });

    });
</script>