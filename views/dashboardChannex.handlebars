<h2>Dashboard Channex</h2>
<div class="row">
    <div class="col-md-7">
        <h4>Propiedades locales en Channex</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Nombre local</th>
                    <th>ID Channex</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                {{#each propiedades}}
                <tr>
                    <td>{{propertyDetails.name}}</td>
                    <td>
                        {{channexPropertyId}}
                        {{!-- Puedes buscar el nombre en chProps si ya está mapeada --}}
                    </td>
                    <td>
                        {{#if isMapped}}
                            <span class="badge bg-success">Mapeada</span>
                        {{else}}
                            <form action="" method="POST" class="d-inline">
                                <button class="btn btn-sm btn-primary map-btn" data-id="{{_id}}">Mapear</button>
                            </form>
                        {{/if}}
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    <div class="col-md-5">
        <h4>Listings de Airbnb</h4>
        <ul class="list-group">
            {{#each chProps}}
            <li class="list-group-item">
                <span class="fw-bold">{{this.title}}</span>  
                <small>(ID: {{this.id}})</small>
            </li>
            {{/each}}
        </ul>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const mapButtons = document.querySelectorAll('.map-btn');
        mapButtons.forEach(button => {
            button.addEventListener('click', async function (event) {
                event.preventDefault();
                const propertyId = this.getAttribute('data-id');
                try {
                    const response = await fetch(`/api/channex/channels/${propertyId}/mappings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ propertyId })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Propiedad mapeada',
                            text: data.message,
                            confirmButtonText: 'Aceptar'
                        }).then(() => window.location.reload());
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error al mapear la propiedad: ' + error.message,
                        confirmButtonText: 'Aceptar'
                    })
                }
            });
        });
    });
</script>
