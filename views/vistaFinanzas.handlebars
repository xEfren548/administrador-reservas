<!-- Spinner Global de Carga -->
<div id="globalSpinner" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 hidden">
    <div class="bg-white rounded-lg shadow-2xl p-4 border border-gray-200">
        <div class="flex items-center space-x-3">
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-teal-500"></div>
            <p class="text-gray-900 text-sm font-medium">Cargando...</p>
        </div>
    </div>
</div>

<div class="min-h-screen bg-gray-50 text-gray-800">
    <!-- Header con acciones principales -->
    <div class="bg-white border-b border-gray-200 px-4 py-4 sm:px-6 lg:px-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Finanzas</h1>
                <p class="mt-1 text-sm text-gray-500">Gestiona organizaciones, cuentas y transacciones</p>
            </div>
            <div class="flex flex-wrap gap-2">
                {{#if isMasterAdmin}}
                <button id="btn-nueva-organizacion" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalOrganizacion">
                    <i class="fas fa-building me-1"></i> Nueva Organización
                </button>
                {{/if}}
                <button id="btn-nueva-cuenta" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalCuenta">
                    <i class="fas fa-wallet me-1"></i> Nueva Cuenta
                </button>
            </div>
        </div>
    </div>

    <!-- Tabs de navegación -->
    <div class="bg-white border-b border-gray-200">
        <div class="px-4 sm:px-6 lg:px-8">
            <nav class="flex space-x-4 overflow-x-auto scrollbar-hide" aria-label="Tabs">
                <button class="tab-button active whitespace-nowrap px-4 py-3 text-sm font-medium border-b-2 border-teal-500 text-teal-600" data-tab="dashboard">
                    <i class="fas fa-chart-line me-1"></i> Dashboard
                </button>
                <button class="tab-button whitespace-nowrap px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-600 hover:border-gray-300" data-tab="organizaciones">
                    <i class="fas fa-building me-1"></i> Organizaciones
                </button>
                <button class="tab-button whitespace-nowrap px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-600 hover:border-gray-300" data-tab="cuentas">
                    <i class="fas fa-wallet me-1"></i> Mis Cuentas
                </button>
                <button class="tab-button whitespace-nowrap px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-600 hover:border-gray-300" data-tab="transacciones">
                    <i class="fas fa-exchange-alt me-1"></i> Transacciones
                </button>
                <button class="tab-button whitespace-nowrap px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-600 hover:border-gray-300" data-tab="solicitudes">
                    <i class="fas fa-clock me-1"></i> Solicitudes
                </button>
                <button class="tab-button whitespace-nowrap px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-600 hover:border-gray-300" data-tab="recurrentes">
                    <i class="fas fa-repeat me-1"></i> Recurrentes y Diferidos
                </button>
            </nav>
        </div>
    </div>

    <!-- Contenido de tabs -->
    <div class="px-4 py-6 sm:px-6 lg:px-8">
        
        <!-- Tab: Dashboard -->
        <div id="tab-dashboard" class="tab-content active">
            <!-- Selector de Vista -->
            <div class="mb-6 flex flex-wrap gap-4">
                <select id="dashboard-selector" class="form-select bg-gray-100 border-gray-300 text-gray-700 w-auto">
                    <option value="personal">Vista Personal</option>
                    <option value="organizacion">Vista de Organización</option>
                </select>
                <select id="organizacion-selector" class="form-select bg-gray-100 border-gray-300 text-gray-700 w-auto hidden">
                    <option value="">Seleccione una organización</option>
                </select>
                
                <!-- Filtro de Fechas -->
                <div class="flex gap-2 items-center">
                    <label class="text-gray-600 text-sm">Desde:</label>
                    <input type="date" id="fecha-desde" class="form-control form-control-sm bg-gray-100 border-gray-300 text-gray-700 w-auto">
                    <label class="text-gray-600 text-sm">Hasta:</label>
                    <input type="date" id="fecha-hasta" class="form-control form-control-sm bg-gray-100 border-gray-300 text-gray-700 w-auto">
                    <button id="btn-aplicar-filtro-fechas" class="btn btn-primary btn-sm">
                        <i class="fas fa-filter me-1"></i> Aplicar
                    </button>
                    <button id="btn-limpiar-filtro-fechas" class="btn btn-secondary btn-sm">
                        <i class="fas fa-times me-1"></i> Limpiar
                    </button>
                </div>
            </div>

            <!-- Dashboard Personal -->
            <div id="dashboard-personal">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Mi Resumen Personal</h2>
                
                <!-- Tarjetas de Resumen -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg p-6 shadow-lg border-l-4 border-teal-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Saldo Total</p>
                                <p id="personal-saldo-total" class="text-3xl font-bold text-gray-900 mt-2">$0.00</p>
                            </div>
                            <div class="bg-teal-100 rounded-full p-3">
                                <i class="fas fa-wallet text-2xl text-teal-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 shadow-lg border-l-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Total Ingresos</p>
                                <p id="personal-ingresos" class="text-3xl font-bold text-green-600 mt-2">$0.00</p>
                            </div>
                            <div class="bg-green-100 rounded-full p-3">
                                <i class="fas fa-arrow-up text-2xl text-green-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 shadow-lg border-l-4 border-red-500">
                        <di class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Total Gastos</p>
                                <p id="personal-gastos" class="text-3xl font-bold text-red-600 mt-2">$0.00</p>
                            </div>
                            <div class="bg-red-100 rounded-full p-3">
                                <i class="fas fa-arrow-down text-2xl text-red-600"></i>
                            </div>
                        </di`>`
                    </div>

                    <div class="bg-white rounded-lg p-6 shadow-lg border-l-4 border-purple-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Mis Cuentas</p>
                                <p id="personal-num-cuentas" class="text-3xl font-bold text-purple-600 mt-2">0</p>
                            </div>
                            <div class="bg-purple-100 rounded-full p-3">
                                <i class="fas fa-folder text-2xl text-purple-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficas y Tablas Personal -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-lg p-6 shadow-xl">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Transacciones por Cuenta</h3>
                        <div style="height: 300px;">
                            <canvas id="personal-chart-cuentas"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 shadow-xl">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Transacciones Recientes</h3>
                        <div id="personal-transacciones-recientes" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- Mi Resumen de Organizaciones -->
                <div class="bg-white rounded-lg p-6 shadow-xl mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-building mr-2"></i>Mi Resumen de Organizaciones
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">Balance de mis transacciones en organizaciones donde participo</p>
                    
                    <!-- Card de Balance Total -->
                    <div class="bg-white border-l-4 border-teal-500 rounded-lg p-6 shadow-xl mb-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium mb-2">Balance Total en Organizaciones</p>
                                <p id="org-balance-total" class="text-3xl font-bold text-gray-900">$0.00</p>
                            </div>
                            <div class="bg-teal-100 rounded-full p-4">
                                <i class="fas fa-balance-scale text-3xl text-teal-600"></i>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-200">
                            <div>
                                <p class="text-gray-500 text-xs mb-1">Total Ingresos</p>
                                <p id="org-balance-ingresos" class="text-green-600 font-bold text-lg">$0.00</p>
                            </div>
                            <div>
                                <p class="text-gray-500 text-xs mb-1">Total Gastos</p>
                                <p id="org-balance-gastos" class="text-red-600 font-bold text-lg">$0.00</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="personal-resumen-organizaciones" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Dashboard Organización -->
            <div id="dashboard-organizacion" class="hidden">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Dashboard de Organización</h2>
                
                <!-- Tarjetas de Resumen Organización -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
                    <div class="bg-white border-l-4 border-teal-500 rounded-lg p-6 shadow-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Saldo Total</p>
                                <p id="org-saldo-total" class="text-2xl font-bold text-gray-900 mt-2">$0.00</p>
                            </div>
                            <i class="fas fa-wallet text-3xl text-teal-600"></i>
                        </div>
                    </div>

                    <div class="bg-white border-l-4 border-green-500 rounded-lg p-6 shadow-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Ingresos</p>
                                <p id="org-ingresos" class="text-2xl font-bold text-gray-900 mt-2">$0.00</p>
                            </div>
                            <i class="fas fa-arrow-up text-3xl text-green-600"></i>
                        </div>
                    </div>

                    <div class="bg-white border-l-4 border-red-500 rounded-lg p-6 shadow-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Gastos</p>
                                <p id="org-gastos" class="text-2xl font-bold text-gray-900 mt-2">$0.00</p>
                            </div>
                            <i class="fas fa-arrow-down text-3xl text-red-600"></i>
                        </div>
                    </div>

                    <div class="bg-white border-l-4 border-purple-500 rounded-lg p-6 shadow-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Cuentas</p>
                                <p id="org-num-cuentas" class="text-2xl font-bold text-gray-900 mt-2">0</p>
                            </div>
                            <i class="fas fa-folder text-3xl text-purple-600"></i>
                        </div>
                    </div>

                    <div class="bg-white border-l-4 border-yellow-500 rounded-lg p-6 shadow-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Transacciones</p>
                                <p id="org-num-transacciones" class="text-2xl font-bold text-gray-900 mt-2">0</p>
                            </div>
                            <i class="fas fa-exchange-alt text-3xl text-yellow-600"></i>
                        </div>
                    </div>

                    <div class="bg-white border-l-4 border-indigo-500 rounded-lg p-6 shadow-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Participantes</p>
                                <p id="org-num-participantes-unicos" class="text-2xl font-bold text-gray-900 mt-2">0</p>
                            </div>
                            <i class="fas fa-users text-3xl text-indigo-600"></i>
                        </div>
                    </div>
                </div>

                <!-- Resumen del Mes -->
                <div class="bg-white rounded-lg p-6 shadow-xl mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Resumen del Mes Actual</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-100 rounded-lg p-4">
                            <p class="text-gray-500 text-sm">Ingresos del Mes</p>
                            <p id="org-ingresos-mes" class="text-2xl font-bold text-green-600 mt-2">$0.00</p>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-4">
                            <p class="text-gray-500 text-sm">Gastos del Mes</p>
                            <p id="org-gastos-mes" class="text-2xl font-bold text-red-600 mt-2">$0.00</p>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-4">
                            <p class="text-gray-500 text-sm">Balance del Mes</p>
                            <p id="org-balance-mes" class="text-2xl font-bold text-teal-600 mt-2">$0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Gráficas Organización -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-lg p-6 shadow-xl">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Evolución (Últimos 6 Meses)</h3>
                        <div style="height: 300px;">
                            <canvas id="org-chart-evolucion"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 shadow-xl">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Gastos por Categoría</h3>
                        <div style="height: 300px;">
                            <canvas id="org-chart-categorias"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Usuarios y Mi Participación -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg p-6 shadow-xl">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Usuarios por Actividad</h3>
                        <div id="org-top-usuarios" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 shadow-xl">
                        <h3 class="te`t-lg font-semibol` text-gray-900 mb-4">Mi Participación</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg">
                                <span class="text-gray-600">Mis Ingresos</span>
                                <span id="org-mis-ingresos" class="text-green-600 font-bold">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg">
                                <span class="text-gray-600">Mis Gastos</span>
                                <span id="org-mis-gastos" class="text-red-600 font-bold">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg">
                                <span class="text-gray-600">Mi Balance</span>
                                <span id="org-mi-balance" class="text-teal-600 font-bold">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg">
                                <span class="text-gray-600">Mis Transacciones</span>
                                <span id="org-mis-transacciones" class="text-purple-400 font-bold">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Organizaciones -->
        <div id="tab-organizaciones" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                <div class="p-4 sm:p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">Organizaciones</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">Nombre</th>
                                <th scope="col" class="px-6 py-3">Descripción</th>
                                <th scope="col" class="px-6 py-3">Participantes</th>
                                <th scope="col" class="px-6 py-3">Estado</th>
                                <th scope="col" class="px-6 py-3">Fecha Creación</th>
                                <th scope="col" class="px-6 py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-organizaciones-body">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Mis Cuentas -->
        <div id="tab-cuentas" class="tab-content hidden">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 mb-6">
                <!-- Cards de cuentas se llenarán dinámicamente -->
                <div id="cuentas-grid" class="col-span-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Se llenará con JS -->
                </div>
            </div>
        </div>

        <!-- Tab: Transacciones -->
        <div id="tab-transacciones" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                <div class="p-4 sm:p-6 border-b border-gray-200">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <h2 class="text-xl font-semibold text-gray-900">Transacciones</h2>
                        <select id="filtro-cuenta-transacciones" class="form-select form-select-sm bg-gray-100 border-gray-300 text-gray-700">
                            <option value="">Todas las cuentas</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600" id="tabla-transacciones">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">Fecha</th>
                                <th scope="col" class="px-6 py-3">Tipo</th>
                                <th scope="col" class="px-6 py-3">Concepto</th>
                                <th scope="col" class="px-6 py-3">Categoría</th>
                                <th scope="col" class="px-6 py-3 text-right">Monto</th>
                                <th scope="col" class="px-6 py-3">Estado</th>
                                <th scope="col" class="px-6 py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-transacciones-body">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Solicitudes -->
        <div id="tab-solicitudes" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                <div class="p-4 sm:p-6 border-b border-gray-200">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <h2 class="text-xl font-semibold text-gray-900">Solicitudes Pendientes</h2>
                        <button id="btn-nueva-solicitud" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalSolicitud">
                            <i class="fas fa-plus me-1"></i> Nueva Solicitud
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">Fecha</th>
                                <th scope="col" class="px-6 py-3">Cuenta</th>
                                <th scope="col" class="px-6 py-3">Tipo</th>
                                <th scope="col" class="px-6 py-3">Concepto</th>
                                <th scope="col" class="px-6 py-3">Solicitante</th>
                                <th scope="col" class="px-6 py-3 text-right">Monto</th>
                                <th scope="col" class="px-6 py-3">Estado</th>
                                <th scope="col" class="px-6 py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-solicitudes-body">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Recurrentes y Diferidos -->
        <div id="tab-recurrentes" class="tab-content hidden">
            <!-- Sub-tabs -->
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <button class="nav-link active" onclick="mostrarSubtab('recurrentes')" id="subtab-btn-recurrentes">
                        <i class="fas fa-sync-alt me-1"></i> Transacciones Recurrentes
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="mostrarSubtab('diferidos')" id="subtab-btn-diferidos">
                        <i class="fas fa-calendar-alt me-1"></i> Pagos Diferidos
                    </button>
                </li>
            </ul>

            <div>
                <!-- Tabla de recurrentes -->
                <div id="subtab-recurrentes" class="subtab-content">
                    <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                        <div class="p-4 sm:p-6 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <h2 class="text-xl font-semibold text-gray-900">Transacciones Recurrentes</h2>
                                <div class="flex gap-2">
                                    <button id="btn-nueva-recurrente" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalTransaccionRecurrente">
                                        <i class="fas fa-plus me-1"></i> Nueva Recurrente
                                    </button>
                                    <button id="btn-ejecutar-recurrentes-ahora" class="btn btn-warning btn-sm" title="Ejecutar ahora (para pruebas)">
                                        <i class="fas fa-play me-1"></i> Ejecutar Ahora
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-500 uppercase bg-gray-100">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Concepto</th>
                                        <th scope="col" class="px-6 py-3">Cuenta</th>
                                        <th scope="col" class="px-6 py-3">Tipo</th>
                                        <th scope="col" class="px-6 py-3 text-right">Monto</th>
                                        <th scope="col" class="px-6 py-3">Frecuencia</th>
                                        <th scope="col" class="px-6 py-3">Próxima Ejecución</th>
                                        <th scope="col" class="px-6 py-3">Estado</th>
                                        <th scope="col" class="px-6 py-3 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-recurrentes-body">
                                    <!-- Se llenará dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tabla de diferidos -->
                <div id="subtab-diferidos" class="subtab-content hidden">
                    <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                        <div class="p-4 sm:p-6 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <h2 class="text-xl font-semibold text-gray-900">Pagos Diferidos a Meses</h2>
                                <div class="flex gap-2">
                                    <button id="btn-nuevo-diferido" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalPagoDiferido">
                                        <i class="fas fa-plus me-1"></i> Nuevo Pago Diferido
                                    </button>
                                    <button id="btn-verificar-cuotas-ahora" class="btn btn-warning btn-sm" title="Verificar cuotas ahora (para pruebas)">
                                        <i class="fas fa-check me-1"></i> Verificar Cuotas
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-500 uppercase bg-gray-100">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Concepto</th>
                                        <th scope="col" class="px-6 py-3">Cuenta</th>
                                        <th scope="col" class="px-6 py-3 text-right">Monto Total</th>
                                        <th scope="col" class="px-6 py-3 text-center">Cuotas</th>
                                        <th scope="col" class="px-6 py-3 text-right">Pagadas</th>
                                        <th scope="col" class="px-6 py-3">Progreso</th>
                                        <th scope="col" class="px-6 py-3">Estado</th>
                                        <th scope="col" class="px-6 py-3 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-diferidos-body">
                                    <!-- Se llenará dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Modal: Nueva/Editar Organización -->
<div class="modal fade" id="modalOrganizacion" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-white text-gray-800">
            <div class="modal-header border-gray-200">
                <h5 class="modal-title" id="modalOrganizacionTitle">Nueva Organización</h5>
                <button type="button" class="btn-close btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formOrganizacion">
                    <input type="hidden" id="organizacion-id">
                    
                    <!-- Información básica -->
                    <div class="mb-3">
                        <label for="organizacion-nombre" class="form-label">Nombre *</label>
                        <input type="text" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="organizacion-nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="organizacion-descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control bg-gray-100 border-gray-300 text-gray-800" id="organizacion-descripcion" rows="3"></textarea>
                    </div>

                    <!-- Participantes (solo al crear) -->
                    <div id="organizacion-participantes-section">
                        <div class="border-top border-gray-200 pt-3 mt-3">
                            <h6 class="text-gray-700 mb-3">
                                <i class="fas fa-users me-1"></i> Participantes
                            </h6>
                            <p class="text-gray-500 text-sm mb-3">Agrega miembros a esta organización. Tú serás agregado automáticamente como Administrador.</p>
                            
                            <div class="mb-3">
                                <label for="organizacion-nuevo-participante" class="form-label">Agregar participante</label>
                                <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="organizacion-nuevo-participante">
                                    <option value="">Seleccione un usuario...</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="organizacion-rol-participante" class="form-label">Rol</label>
                                <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="organizacion-rol-participante">
                                    <option value="Miembro">Miembro</option>
                                    <option value="Administrador">Administrador</option>
                                </select>
                            </div>

                            <button type="button" class="btn btn-sm btn-success mb-3" id="btnAgregarParticipanteOrg">
                                <i class="fas fa-plus me-1"></i> Agregar
                            </button>

                            <!-- Lista de participantes agregados -->
                            <div id="lista-participantes-org" class="mt-3">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-gray-200">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarOrganizacion">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Gestionar Participantes de Organización -->
<div class="modal fade" id="modalParticipantesOrganizacion" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-white text-gray-800">
            <div class="modal-header border-gray-200">
                <h5 class="modal-title">
                    <i class="fas fa-users me-1"></i> Gestionar Participantes
                </h5>
                <button type="button" class="btn-close btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="participantes-org-id">
                
                <!-- Agregar nuevo participante -->
                <div class="mb-4 p-3 bg-gray-50 rounded">
                    <h6 class="text-gray-700 mb-3">Agregar nuevo participante</h6>
                    <div class="row">
                        <div class="col-md-7 mb-2">
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="nuevo-participante-org-select">
                                <option value="">Seleccione un usuario...</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="nuevo-participante-org-rol">
                                <option value="Miembro">Miembro</option>
                                <option value="Administrador">Administrador</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <button type="button" class="btn btn-success w-100" id="btnAgregarParticipanteOrgGestion">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lista de participantes actuales -->
                <div>
                    <h6 class="text-gray-700 mb-3">Participantes actuales</h6>
                    <div id="lista-participantes-org-gestion" class="space-y-2">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>
            <div class="modal-footer border-gray-200">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Nueva/Editar Cuenta -->
<div class="modal fade" id="modalCuenta" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-white text-gray-800">
            <div class="modal-header border-gray-200">
                <h5 class="modal-title" id="modalCuentaTitle">Nueva Cuenta</h5>
                <button type="button" class="btn-close btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCuenta">
                    <input type="hidden" id="cuenta-id">
                    
                    <!-- Información básica -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cuenta-nombre" class="form-label">Nombre de la Cuenta *</label>
                            <input type="text" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="cuenta-nombre" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cuenta-organizacion" class="form-label">Organización *</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="cuenta-organizacion" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="cuenta-tipo" class="form-label">Tipo de Cuenta</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="cuenta-tipo">
                                <option value="Bancaria">Bancaria</option>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Tarjeta">Tarjeta</option>
                                <option value="Billetera Digital">Billetera Digital</option>
                                <option value="Otra">Otra</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="cuenta-moneda" class="form-label">Moneda</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="cuenta-moneda">
                                <option value="MXN">MXN</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="cuenta-saldo-inicial" class="form-label">Saldo Inicial</label>
                            <input type="number" step="0.01" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="cuenta-saldo-inicial" value="0">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="cuenta-descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control bg-gray-100 border-gray-300 text-gray-800" id="cuenta-descripcion" rows="2"></textarea>
                    </div>

                    <!-- Datos Bancarios -->
                    <div class="border-top border-gray-200 pt-3 mt-3">
                        <h6 class="text-gray-600 mb-3">Datos Bancarios (Opcional)</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cuenta-beneficiario" class="form-label">Beneficiario</label>
                                <input type="text" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="cuenta-beneficiario">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cuenta-banco" class="form-label">Banco</label>
                                <input type="text" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="cuenta-banco">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cuenta-clabe" class="form-label">CLABE</label>
                                <input type="text" maxlength="18" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="cuenta-clabe">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cuenta-numero" class="form-label">Número de Cuenta</label>
                                <input type="text" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="cuenta-numero">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="cuenta-referencia" class="form-label">Referencia</label>
                            <input type="text" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="cuenta-referencia">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-gray-200">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnGuardarCuenta">Guardar Cuenta</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Nueva Solicitud -->
<div class="modal fade" id="modalSolicitud" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-white text-gray-800">
            <div class="modal-header border-gray-200">
                <h5 class="modal-title">Nueva Solicitud de Transacción</h5>
                <button type="button" class="btn-close btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formSolicitud">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="solicitud-cuenta" class="form-label">Cuenta *</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="solicitud-cuenta" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="solicitud-tipo" class="form-label">Tipo *</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="solicitud-tipo" required>
                                <option value="Gasto">Gasto</option>
                                <option value="Ingreso">Ingreso</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="solicitud-monto" class="form-label">Monto *</label>
                            <input type="number" step="0.01" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="solicitud-monto" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="solicitud-concepto" class="form-label">Concepto *</label>
                            <input type="text" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="solicitud-concepto" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="solicitud-categoria" class="form-label">Categoría *</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="solicitud-categoria" required>
                                <option value="Otro">Otro</option>
                                <option value="Alimentación">Alimentación</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Compras">Compras</option>
                                <option value="Salud">Salud</option>
                                <option value="Entretenimiento">Entretenimiento</option>
                                <option value="Educación">Educación</option>
                                <option value="Hogar">Hogar</option>
                                <option value="Salario">Salario</option>
                                <option value="Venta">Venta</option>
                                <option value="Inversión">Inversión</option>
                                <option value="Préstamo">Préstamo</option>
                                <option value="Reembolso">Reembolso</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="solicitud-descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control bg-gray-100 border-gray-300 text-gray-800" id="solicitud-descripcion" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="solicitud-fecha" class="form-label">Fecha</label>
                        <input type="date" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="solicitud-fecha">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            Comprobantes/Tickets 
                            <small class="text-gray-500">(Opcional, máx. 3 imágenes)</small>
                        </label>
                        <input type="file" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="solicitud-imagenes" accept="image/*" multiple>
                        <small class="text-gray-500">Formatos: JPG, PNG, WEBP. Máximo 3 archivos.</small>
                        <div id="preview-solicitud-imagenes" class="mt-2 d-flex gap-2 flex-wrap"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-gray-200">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btnGuardarSolicitud">Enviar Solicitud</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Nueva Transacción Recurrente -->
<div class="modal fade" id="modalTransaccionRecurrente" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-white text-gray-800">
            <div class="modal-header border-gray-200">
                <h5 class="modal-title">Nueva Transacción Recurrente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formTransaccionRecurrente">
                    <!-- Información básica -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rec-cuenta" class="form-label">Cuenta *</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="rec-cuenta" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="rec-tipo" class="form-label">Tipo *</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="rec-tipo" required>
                                <option value="Gasto">Gasto</option>
                                <option value="Ingreso">Ingreso</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="rec-monto" class="form-label">Monto *</label>
                            <input type="number" step="0.01" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="rec-monto" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="rec-concepto" class="form-label">Concepto *</label>
                            <input type="text" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="rec-concepto" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="rec-categoria" class="form-label">Categoría *</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="rec-categoria" required>
                                <option value="Otro">Otro</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Hogar">Hogar</option>
                                <option value="Salario">Salario</option>
                                <option value="Préstamo">Préstamo</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="rec-descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control bg-gray-100 border-gray-300 text-gray-800" id="rec-descripcion" rows="2"></textarea>
                    </div>

                    <!-- Configuración de recurrencia -->
                    <div class="border-top border-gray-300 pt-3 mt-3">
                        <h6 class="text-gray-900 mb-3"><i class="fas fa-sync-alt me-2"></i>Configuración de Recurrencia</h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="rec-frecuencia" class="form-label">
                                    Frecuencia *
                                    <i class="fas fa-info-circle ms-1 text-gray-400" title="Con qué frecuencia se repetirá esta transacción"></i>
                                </label>
                                <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="rec-frecuencia" required>
                                    <option value="Diaria">Diaria</option>
                                    <option value="Semanal">Semanal</option>
                                    <option value="Quincenal">Quincenal</option>
                                    <option value="Mensual" selected>Mensual</option>
                                    <option value="Bimestral">Bimestral</option>
                                    <option value="Trimestral">Trimestral</option>
                                    <option value="Anual">Anual</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="rec-dia" class="form-label">
                                    Día de ejecución
                                    <i class="fas fa-info-circle ms-1 text-gray-400" title="Día del mes en que se ejecutará (ej: 1 para el primer día del mes)"></i>
                                </label>
                                <input type="number" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="rec-dia" min="1" max="31" placeholder="Opcional (1-31)">
                                <small class="text-gray-500">Solo para frecuencia mensual</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="rec-fecha-inicio" class="form-label">Fecha de inicio *</label>
                                <input type="date" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="rec-fecha-inicio" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="rec-fecha-fin" class="form-label">Fecha de fin (opcional)</label>
                                <input type="date" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="rec-fecha-fin">
                                <small class="text-gray-500">Dejar vacío para indefinido</small>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="rec-automatica">
                            <label class="form-check-label text-gray-800" for="rec-automatica">
                                <span class="d-flex align-items-center">
                                    Ejecutar automáticamente (sin aprobación manual)
                                    <i class="fas fa-info-circle ms-2 text-blue-500" 
                                       title="✓ Marcado: Se ejecuta automáticamente en la fecha programada&#10;✗ Desmarcado: Requiere aprobación manual cada vez"
                                       data-bs-toggle="tooltip"
                                       data-bs-html="true"></i>
                                </span>
                            </label>
                            <small class="text-gray-600 d-block mt-1">
                                <strong>Marcado:</strong> La transacción se procesa automáticamente (ideal para gastos fijos como renta o servicios)<br>
                                <strong>Desmarcado:</strong> Recibirás un recordatorio y deberás aprobar manualmente (ideal para gastos variables)
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="rec-notificar" class="form-label">
                                Notificar con anticipación (días)
                                <i class="fas fa-info-circle ms-1 text-gray-400" title="Cuántos días antes de la ejecución deseas recibir una notificación"></i>
                            </label>
                            <input type="number" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="rec-notificar" value="1" min="0">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-gray-200">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarRecurrente">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Nuevo Pago Diferido -->
<div class="modal fade" id="modalPagoDiferido" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-white text-gray-800">
            <div class="modal-header border-gray-200">
                <h5 class="modal-title">Configurar Pago Diferido a Meses</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formPagoDiferido">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dif-cuenta" class="form-label">Cuenta *</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="dif-cuenta" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dif-monto-total" class="form-label">Monto Total *</label>
                            <input type="number" step="0.01" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="dif-monto-total" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dif-num-pagos" class="form-label">
                                Número de Pagos (Meses) *
                                <i class="fas fa-info-circle ms-1 text-gray-400" title="En cuántos meses dividirás el pago total (mínimo 2)"></i>
                            </label>
                            <input type="number" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="dif-num-pagos" min="2" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="dif-interes" class="form-label">
                                Interés Mensual (%)
                                <i class="fas fa-info-circle ms-1 text-gray-400" title="Tasa de interés mensual que se aplicará. Dejar en 0 para pagos sin intereses (meses sin intereses)"></i>
                            </label>
                            <input type="number" step="0.01" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="dif-interes" value="0" min="0" placeholder="0 = sin intereses">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="dif-fecha-inicio" class="form-label">
                            Fecha del Primer Pago *
                            <i class="fas fa-info-circle ms-1 text-gray-400" title="Fecha en que se realizará el primer pago. Los siguientes pagos serán un mes después de cada pago anterior"></i>
                        </label>
                        <input type="date" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="dif-fecha-inicio" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="dif-concepto" class="form-label">Concepto *</label>
                            <input type="text" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="dif-concepto" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="dif-categoria" class="form-label">Categoría</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="dif-categoria">
                                <option value="Otro">Otro</option>
                                <option value="Compras">Compras</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Préstamo">Préstamo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="dif-descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control bg-gray-100 border-gray-300 text-gray-800" id="dif-descripcion" rows="2"></textarea>
                    </div>
                    
                    <!-- Preview de cuotas -->
                    <div class="border-top border-gray-300 pt-3 mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-gray-900 mb-0"><i class="fas fa-calculator me-2"></i>Vista Previa de Cuotas</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btnCalcularCuotas">
                                <i class="fas fa-sync me-1"></i>Calcular
                            </button>
                        </div>
                        <div id="preview-cuotas" class="table-responsive">
                            <p class="text-gray-500 text-center py-3">Completa los datos y haz clic en "Calcular" para ver las cuotas</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-gray-200">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarDiferido">Crear Pago Diferido</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Detalle de Cuenta -->
<div class="modal fade" id="modalDetalleCuenta" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-white text-gray-800">
            <div class="modal-header border-gray-200">
                <h5 class="modal-title" id="detalleCuentaNombre">Detalle de Cuenta</h5>
                <button type="button" class="btn-close btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detalleCuentaContent">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Agregar Participante -->
<div class="modal fade" id="modalParticipantes" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-white text-gray-800">
            <div class="modal-header border-gray-200">
                <h5 class="modal-title">Agregar Participante</h5>
                <button type="button" class="btn-close btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formParticipante">
                    <input type="hidden" id="participanteCuentaId">
                    
                    <div class="mb-4">
                        <label for="selectUsuario" class="form-label text-gray-600">Seleccionar Usuario</label>
                        <select class="form-select bg-gray-100 text-gray-900 border-gray-300" id="selectUsuario" required>
                            <option value="">Seleccione un usuario...</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-gray-600 mb-2">Permisos</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="checkVerTransacciones">
                            <label class="form-check-label text-gray-600" for="checkVerTransacciones">
                                Puede ver transacciones
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="checkCrearSolicitudes">
                            <label class="form-check-label text-gray-600" for="checkCrearSolicitudes">
                                Puede crear solicitudes de transacción
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="checkVerSaldo">
                            <label class="form-check-label text-gray-600" for="checkVerSaldo">
                                Puede ver saldo de la cuenta
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-gray-200">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarParticipante">Agregar Participante</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Nueva Transacción -->
<div class="modal fade" id="modalTransaccion" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-white text-gray-800">
            <div class="modal-header border-gray-200">
                <h5 class="modal-title">Nueva Transacción</h5>
                <button type="button" class="btn-close btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formTransaccion">
                    <input type="hidden" id="transaccion-cuenta-id">
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="transaccion-tipo" class="form-label">Tipo *</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="transaccion-tipo" required>
                                <option value="Gasto">Gasto</option>
                                <option value="Ingreso">Ingreso</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="transaccion-monto" class="form-label">Monto *</label>
                            <input type="number" step="0.01" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="transaccion-monto" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="transaccion-categoria" class="form-label">Categoría *</label>
                            <select class="form-select bg-gray-100 border-gray-300 text-gray-800" id="transaccion-categoria" required>
                                <option value="Otro">Otro</option>
                                <option value="Alimentación">Alimentación</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Compras">Compras</option>
                                <option value="Salud">Salud</option>
                                <option value="Entretenimiento">Entretenimiento</option>
                                <option value="Educación">Educación</option>
                                <option value="Hogar">Hogar</option>
                                <option value="Salario">Salario</option>
                                <option value="Venta">Venta</option>
                                <option value="Inversión">Inversión</option>
                                <option value="Préstamo">Préstamo</option>
                                <option value="Reembolso">Reembolso</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="transaccion-concepto" class="form-label">Concepto *</label>
                        <input type="text" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="transaccion-concepto" required>
                    </div>

                    <div class="mb-3">
                        <label for="transaccion-descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control bg-gray-100 border-gray-300 text-gray-800" id="transaccion-descripcion" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="transaccion-fecha" class="form-label">Fecha</label>
                        <input type="date" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="transaccion-fecha">
                    </div>

                    <div class="mb-3">
                        <label for="transaccion-notas" class="form-label">Notas adicionales</label>
                        <textarea class="form-control bg-gray-100 border-gray-300 text-gray-800" id="transaccion-notas" rows="2" placeholder="Notas internas..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            Comprobantes/Tickets 
                            <small class="text-gray-500">(Opcional, máx. 3 imágenes)</small>
                        </label>
                        <input type="file" class="form-control bg-gray-100 border-gray-300 text-gray-800" id="transaccion-imagenes" accept="image/*" multiple>
                        <small class="text-gray-500">Formatos: JPG, PNG, WEBP. Máximo 3 archivos.</small>
                        <div id="preview-imagenes" class="mt-2 d-flex gap-2 flex-wrap"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-gray-200">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarTransaccion">Crear Transacción</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Ver/Gestionar Imágenes de Transacción -->
<div class="modal fade" id="modalImagenesTransaccion" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-white text-gray-800">
            <div class="modal-header border-gray-200">
                <h5 class="modal-title">Comprobantes de Transacción</h5>
                <button type="button" class="btn-close btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modal-imagenes-transaccion-id">
                
                <!-- Área para mostrar imágenes existentes -->
                <div id="imagenes-existentes-container" class="mb-4">
                    <h6 class="text-gray-600 mb-3">Imágenes actuales:</h6>
                    <div id="imagenes-existentes-grid" class="row g-3">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>

                <!-- Área para subir nuevas imágenes (solo si hay menos de 3) -->
                <div id="subir-imagenes-container">
                    <h6 class="text-gray-600 mb-3">Agregar nuevas imágenes:</h6>
                    <input type="file" class="form-control bg-gray-100 border-gray-300 text-gray-800 mb-2" id="nuevas-imagenes-input" accept="image/*" multiple>
                    <small class="text-gray-500">Máximo 3 imágenes en total por transacción</small>
                    <div id="preview-nuevas-imagenes" class="mt-2 row g-2"></div>
                    <button type="button" class="btn btn-sm btn-success mt-3" id="btnSubirNuevasImagenes" style="display: none;">
                        <i class="fas fa-upload me-1"></i> Subir Imágenes
                    </button>
                </div>
            </div>
            <div class="modal-footer border-gray-200">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Visualizar Imagen Completa -->
<div class="modal fade" id="modalVisualizarImagen" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-gray-50 text-gray-800 border-0">
            <div class="modal-header border-gray-200">
                <h5 class="modal-title">Visualizar Comprobante</h5>
                <button type="button" class="btn-close btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="imagen-visualizar-full" src="" alt="Comprobante" class="img-fluid w-100" style="max-height: 80vh; object-fit: contain;">
            </div>
            <div class="modal-footer border-gray-200">
                <a id="btn-descargar-imagen" href="" download class="btn btn-primary">
                    <i class="fas fa-download me-1"></i> Descargar
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Detalle de Transacción -->
<div class="modal fade" id="modalDetalleTransaccion" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-white text-gray-800">
            <div class="modal-header border-gray-200">
                <h5 class="modal-title">Detalle de Transacción</h5>
                <button type="button" class="btn-close btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detalle-transaccion-content">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
            <div class="modal-footer border-gray-200">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<style>
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    
    /* Estilos para subtabs */
    .subtab-content {
        display: block;
    }
    .subtab-content.hidden {
        display: none;
    }
    
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    
    /* Eliminar scroll horizontal de modales */
    .modal-dialog {
        overflow-x: hidden !important;
    }
    .modal-body {
        overflow-x: hidden !important;
    }
    .modal-content {
        overflow-x: hidden !important;
    }
    
    /* Asegurar que los tabs activos tengan el color correcto */
    .tab-button.active {
        color: #0D9488 !important; /* text-teal-600 */
        border-bottom-color: #14B8A6 !important; /* border-teal-500 */
    }
    .tab-button:not(.active) {
        color: #6B7280 !important; /* text-gray-500 */
        border-bottom-color: transparent !important;
    }
    .tab-button:not(.active):hover {
        color: #374151 !important; /* text-gray-700 */
        border-bottom-color: #D1D5DB !important; /* border-gray-300 */
    }

    /* Estilos para preview de imágenes */
    .preview-image-container {
        position: relative;
        display: inline-block;
    }
    .preview-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #E5E7EB;
    }
    .preview-image-remove {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: #EF4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    .preview-image-remove:hover {
        background-color: #DC2626;
    }
    .imagen-existente-card {
        position: relative;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .imagen-existente-card:hover {
        transform: scale(1.05);
    }
    .imagen-existente-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
    }
    .imagen-existente-delete {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: rgba(239, 68, 68, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.2s;
    }
    .imagen-existente-delete:hover {
        background-color: rgba(220, 38, 38, 1);
        transform: scale(1.1);
    }

    /* Select2 Light Theme - Componente reutilizable */
    .select2-container--bootstrap-5 .select2-selection {
        background-color: #ffffff !important;
        border-color: #D1D5DB !important;
        color: #1F2937 !important;
    }
    .select2-container--bootstrap-5 .select2-selection--single {
        height: calc(1.5em + 0.75rem + 2px) !important;
        padding: 0.375rem 0.75rem !important;
    }
    .select2-container--bootstrap-5 .select2-selection__rendered {
        color: #1F2937 !important;
        line-height: 1.5 !important;
        padding-left: 0 !important;
    }
    .select2-container--bootstrap-5 .select2-selection__arrow {
        height: calc(1.5em + 0.75rem + 2px) !important;
    }
    .select2-container--bootstrap-5.select2-container--focus .select2-selection,
    .select2-container--bootstrap-5.select2-container--open .select2-selection {
        border-color: #14B8A6 !important;
        box-shadow: 0 0 0 0.2rem rgba(20, 184, 166, 0.25) !important;
    }
    .select2-dropdown {
        background-color: #ffffff !important;
        border-color: #D1D5DB !important;
    }
    .select2-search--dropdown .select2-search__field {
        background-color: #F9FAFB !important;
        border-color: #D1D5DB !important;
        color: #1F2937 !important;
    }
    .select2-search--dropdown .select2-search__field:focus {
        border-color: #14B8A6 !important;
        outline: none !important;
    }
    .select2-results__option {
        background-color: #ffffff !important;
        color: #1F2937 !important;
    }
    .select2-results__option--highlighted {
        background-color: #14B8A6 !important;
        color: white !important;
    }
    .select2-results__option--selected {
        background-color: #F3F4F6 !important;
    }
    .select2-container--bootstrap-5 .select2-selection__placeholder {
        color: #6B7280 !important;
    }
</style>

<script>
    // Variable global para verificar permisos de MASTER ADMIN
    window.isMasterAdmin = {{#if isMasterAdmin}}true{{else}}false{{/if}};
    // ID del usuario actual
    window.currentUserId = '{{userId}}';
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script src="/scripts/finanzas.js"></script>


